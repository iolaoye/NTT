<% aplcat = 1%>
<% fem = 1 %>
<% if notice != nil %>
    <div class="success_alert">
	  <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
	  <%= notice %>
	</div>
<% end %>
<% if @errors != nil %>
    <% if @errors.length > 0 %>
        <div id="error_explanation">
			<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
			<h2>Simulation failed to run</h2>
			<ul>
				<% @errors.each do |error| %>
				<li>
				  <%= error %>
				</li>
				<% end %>
			</ul>
		</div>
	<% end %>
<% end %>
<div class="overlay">
  <%= image_tag "loading.gif" %>
  <h2>We are simulating your results, this may take a while. Please do not close your browser window</h2>
</div>
<% case %>
  <% when flash[:error] != nil %>
    <div class="danger_alert">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <!--<h2>Simulation failed to run</h2>-->
      <%= flash[:error] %>
	</div>
  <% when flash[:info] %>
	<div class="flash_alert">
	  <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
	  <%= flash[:info] %>
   </div>
<% end %>

<div class="page-header"><h1><%= t('general.management') + " " + t('menu.scenarios') %></h1></div>

<%= button_tag t('general.new') + ' ' + t('scenario.scenario'), :class => 'btn btn-primary', :id => "new_scenario" %>
<%= button_tag t('scenario.other_scenario'), :class => "btn btn-primary", :id => "other_field_scenario" %>
<% @scenario = Scenario.new %>
<div id="div_new" style="display:none" >
	<%= render 'form' %>
</div>

<div class="line_break">
</div>

<div id="div_copy_other" style="display:none">
		<%= render 'other_field_scenario' %>
</div>
<%= form_tag simulate_project_field_scenarios_path(@project, @field), method: :post do |f| %>
    <% if @scenarios.count > 0 %>
		<%= submit_tag t('scenario.simulate') + ' ' + 'NTT', data: {disable_with: 'Please wait. NTT simulation in progress . . .'}, :class => 'btn btn-primary', :id => "simulate_scenario" %>
        <% unless ENV["APP_VERSION"] == "modified" %>
        	<% if aplcat == 1 %>
    			<%= submit_tag t('scenario.simulate') + ' ' + 'APLCAT', data: {disable_with: 'Please wait. APLCAT simulation in progress . . .'}, :class => 'btn btn-primary', :id => "simulate_aplcat" %>
    		<% end %>
    		<% if fem == 1 %>
    			<%#= submit_tag t('scenario.simulate') + ' ' + 'FEM', data: {disable_with: 'Please wait. FEM simulation in progress . . .'}, :class => 'btn btn-primary', :id => "simulate_fem" %>
    		<% end %>
        <% end %>
	    <% if @field.annual_results.count > 0 %>
		    <%= link_to t('general.view') + " " + t('menu.results'), project_field_results_path(@project, @field), :class => 'btn btn-success' %>
		    <% unless ENV["APP_VERSION"] == "modified" %>
          		<%= link_to t('activerecord.models.apex.download') + " " + t('menu.apex_file'), {:action => :download}, :method => :post, :class => 'btn btn-default' %>
          		<% if aplcat == 1 %>
          			<%= link_to t('menu.download_aplcat'), {:action => :download_aplcat}, :method => :post, :class => 'btn btn-default' %>
          		<% end %>
          	<% end %>
        <% end %>
	    <br>
        <br>
        <%= t('instructions.scenarios') %>

		<div class="table-responsive">
		  <div class="panel panel-default">
			<table class="table table-striped", id="tbl_scenarios", name="tbl_scenarios">
			  <thead>
				<tr>
				  <th class="gvCellStyleTitle"><%= check_box_tag "select_all" %></th>
				  <th class="gvCellStyleTitle"><%= t('general.name') %></th>
				  <th class="gvCellStyleTitle"><%= t('menu.weather') %></th>
				  <th class="gvCellStyleTitle"><%= t('menu.soils') %></th>
				  <th class="gvCellStyleTitle"><%= t('menu.layer_file') %></th>
				  <th class="gvCellStyleTitle"><%= t('menu.operation_file') %></th>
				  <th class="gvCellStyleTitle"><%= t('scenario.last_simulation') %></th>
				  <th class="gvCellStyleTitle"><%= t('general.actions') %></th>
				</tr>
			  </thead>
			  <tbody>
				<% i=1 %>
				<% @scenarios.each do |scenario| %>
					<% if (i % 2 == 0) %>
					<tr class="gvRowStyleEven">
					<% else %>
					<tr class="gvRowStyleOdd">
					<% end %>
						<td id="<%= scenario.name %>" class="gvCellStyleText">
						  <%= check_box_tag "select_scenario[]", scenario.id %>
						</td>
						<td class="table-link">
						  <%= link_to scenario.name, project_field_scenario_operations_path(@project, @field, scenario) %>
						</td>
						<td class="gvCellStyleImage">
						  	<% if @field.weather == nil %>
						  		<% link_to(image_tag("warning_icon.png", size: "13x13", :class => 'gvCellStyleImage', :title => t('menu.weather') + " No"), edit_project_field_weather_path(@project, @field, @field.weather)) %>
								<%# warning = true %>
							<% else %>
								<%= image_tag("go_icon.png", size: "13x13", :title => t('menu.weather') + " OK") %>
						  <% end %>
						</td>
						<td class="gvCellStyleImage">
						  	<% if Soil.find_by_field_id(scenario.field_id) == nil %>
								<%= link_to(image_tag("warning_icon.png", size: "13x13", :title => t('menu.soils') + " No"), project_field_soils_path(@project, @field)) %>
						  		<%# warning = true %>
							<% else %>
								<%= image_tag("go_icon.png", size: "13x13", :title => t('menu.soils') + " OK") %>
						  <% end %>
						</td>
						<td class="gvCellStyleImage">
							<% soils = @field.soils %>
							<% found = true %>
							<% soils.each do |soil| %>
								<% if soil.layers.count == 0 then %>
									<% @soil_id = soil.id %>
									<% found = false %>
									<% break %>
								<% end %>
							<% end %>
							<% if found == false %>
								<%# session[:soil_id] = @soil_id %>
								<%= link_to(image_tag("warning_icon.png", size: "13x13", :title => t('menu.layer_file') + " No"), project_field_soil_layers_path(@project, @field, @soil_id)) %>
								<%# warning = true %>
							<% else %>
								<%= image_tag("go_icon.png", size: "13x13", :title => t('menu.layer_file') + " OK") %>
							<% end %>
						</td>
						<td class="gvCellStyleImage">
							<% if scenario.operations.count == 0 %>
								<%= link_to(image_tag("warning_icon.png", size: "13x13", :title => t('menu.operation_file') + " No"), project_field_scenario_operations_path(@project, @field, scenario)) %>
								<%# warning = true %>
							<% else %>
								<%= image_tag("go_icon.png", size: "13x13", :title => t('menu.operation_file') + " OK") %>
							<% end %>
						</td>
						<td class="gvCellStyleText">
						  <%= scenario.last_simulation %>
						</td>
						<td class="gvCellStyleActions">
							<%# if warning == false %>
								<%#= link_to image_tag("aplcat_simulation.png"), aplcat_scenario_path(scenario.id), title: t('scenario.simulate') + " APLCAT", data: {disable_with: 'Please wait. APLCAT simulation in progress . . .'} %>
								<%#= link_to image_tag("run.png"), project_field_scenario_path(@project, @field, scenario.id), title: t('scenario.simulate') + " NTT", data: {disable_with: 'Please wait. NTT simulation in progress . . .'} %>
							<%# end %>
							<%= link_to image_tag("edit.png"), edit_project_field_scenario_path(@project, @field, scenario), title: t('general.edit') %>
							<%= link_to image_tag("copy.jpg"), copy_scenario_project_field_scenario_path(@project, @field, scenario), data: {disable_with: 'Please wait....', method: :get} %>
							<%= link_to image_tag("delete.png"), project_field_scenario_path(@project, @field, scenario), title: t('general.delete'), method: :delete, data: {confirm: t('general.confirm')} %>
						</td>
					 </tr>
					 <% i = i + 1 %>
				<% end %>
			  </tbody>
			</table>
		  </div>
		</div>
    <% end %>
<% end %>

<br>
